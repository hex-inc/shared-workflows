name: "Dependency Review"
on:
  pull_request:
    types:
      - opened
      - synchronize
      - labeled
      - unlabeled

permissions:
  contents: read
  pull-requests: write

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          base-ref: >
            ${{
              github.event_name == 'pull_request' && github.event.pull_request.base.sha ||
              github.event_name == 'merge_group' && github.event.merge_group.base_sha ||
              github.event.repository.default_branch
            }}
          head-ref: ${{ github.event.pull_request.head.sha || github.ref }}

          retry-on-snapshot-warnings: true
          retry-on-snapshot-warnings-timeout: 900

          vulnerability-check: true
          fail-on-severity: moderate

          license-check: true
          # comma-separated SPDX identifiers
          # https://heathermeeker.com/the-license-list/
          # DO NOT ADD LICENSES WITHOUT APPROVAL FROM LEGAL/SECURITY
          allow-licenses: >-
            0BSD,
            AFL-2.1,
            Apache-2.0,
            BlueOak-1.0.0,
            BSD-2-Clause,
            BSD-3-Clause,
            CC-BY-3.0,
            CC-BY-4.0,
            CC0-1.0,
            EPL-2.0,
            ISC,
            LicenseRef-scancode-public-domain,
            MIT,
            MIT-0,
            MPL-2.0,
            PSF-2.0,
            Python-2.0,
            Unlicense,
            WTFPL,
            Zlib

          # npm/@lancedb/lancedb*: Temporary addition due to upstream non-compliance with SPDX
          #                        (https://github.com/lancedb/lancedb/pull/2558)
          # npm/cookie-signature: Temporary addition due to ClearlyDefined error
          #                       (https://github.com/clearlydefined/curated-data/pull/29904)
          allow-dependencies-licenses: >-
            pkg:npm/%2540lancedb/lancedb,
            pkg:npm/%2540lancedb/lancedb-darwin-arm64,
            pkg:npm/%2540lancedb/lancedb-darwin-x64,
            pkg:npm/%2540lancedb/lancedb-linux-arm64-gnu,
            pkg:npm/%2540lancedb/lancedb-linux-arm64-musl,
            pkg:npm/%2540lancedb/lancedb-linux-x64-gnu,
            pkg:npm/%2540lancedb/lancedb-linux-x64-musl,
            pkg:npm/%2540lancedb/lancedb-win32-arm64-msvc,
            pkg:npm/%2540lancedb/lancedb-win32-x64-msvc,
            pkg:npm/cookie-signature,
            pkg:npm/%2540ag-grid-enterprise/master-detail

          comment-summary-in-pr: on-failure
