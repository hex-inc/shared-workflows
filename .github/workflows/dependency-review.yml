name: "Dependency Review"
on:
  pull_request:
    types:
      - opened
      - synchronize
      - labeled
      - unlabeled

permissions:
  contents: read
  pull-requests: write

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          retry-on-snapshot-warnings: true
          retry-on-snapshot-warnings-timeout: 900

          vulnerability-check: true
          fail-on-severity: moderate

          license-check: true
          # comma-separated SPDX identifiers
          # https://heathermeeker.com/the-license-list/
          # DO NOT ADD LICENSES WITHOUT APPROVAL FROM LEGAL/SECURITY
          allow-licenses: >-
            0BSD,
            AFL-2.1,
            Apache-2.0,
            BlueOak-1.0.0,
            BSD-2-Clause,
            BSD-3-Clause,
            CC-BY-3.0,
            CC-BY-4.0,
            CC0-1.0,
            EPL-2.0,
            ISC,
            MIT,
            MIT-0,
            MPL-2.0,
            PSF-2.0,
            Python-2.0,
            Unlicense,
            WTFPL,
            Zlib

          # Temporary addition due to upstream non-compliance with SPDX
          # https://github.com/lancedb/lancedb/pull/2558
          allow-dependencies-licenses: >-
            pkg:npm/%40lancedb%2Flancedb,
            pkg:npm/%40lancedb%2Flancedb-darwin-arm64,
            pkg:npm/%40lancedb%2Flancedb-darwin-x64,
            pkg:npm/%40lancedb%2Flancedb-linux-arm64-gnu,
            pkg:npm/%40lancedb%2Flancedb-linux-arm64-musl,
            pkg:npm/%40lancedb%2Flancedb-linux-x64-gnu,
            pkg:npm/%40lancedb%2Flancedb-linux-x64-musl,
            pkg:npm/%40lancedb%2Flancedb-win32-arm64-msvc,
            pkg:npm/%40lancedb%2Flancedb-win32-x64-msvc

          comment-summary-in-pr: on-failure

          warn-only: true
